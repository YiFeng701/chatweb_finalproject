<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>èŠå¤©å”ä½œç³»çµ±</title>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; background-color: #f4f6f9; }

        /* --- å·¦å´ Sidebar --- */
        #sidebar { width: 250px; background-color: #2c3e50; color: white; display: flex; flex-direction: column; padding: 20px; }
        #user-info { margin-bottom: 30px; border-bottom: 1px solid #34495e; padding-bottom: 20px; text-align: center; }
        #username-display { font-size: 1.2em; font-weight: bold; display: block; margin-bottom: 10px; }
        .nav-btn { background: none; border: none; color: #bdc3c7; padding: 15px; text-align: left; width: 100%; cursor: pointer; border-radius: 8px; font-size: 16px; margin-bottom: 5px; }
        .nav-btn:hover, .nav-btn.active { background-color: #1abc9c; color: white; }
        .btn-edit { background: #34495e; border: 1px solid #7f8c8d; color: #ccc; cursor: pointer; padding: 4px 8px; border-radius: 4px; }

        /* --- å³å´å…§å®¹ --- */
        #main-content { flex: 1; display: flex; flex-direction: column; background: white; position: relative;}
        .page-section { display: none; height: 100%; flex-direction: column; }
        .page-section.active { display: flex; }

        /* --- èŠå¤©å®¤ --- */
        #chat-list { flex: 1; padding: 20px; overflow-y: auto; background: #f9f9f9; list-style: none; margin: 0; }
        #chat-list li { margin-bottom: 8px; }
        #input-area { padding: 15px; border-top: 1px solid #ddd; display: flex; gap: 10px; }
        #msg-input { flex: 1; padding: 10px; font-size: 16px; }

        /* --- ä»»å‹™ç³»çµ± --- */
        #task-container { padding: 40px; max-width: 800px; margin: 0 auto; width: 100%; }
        
        /* ä»»å‹™åˆ—è¡¨æ¨£å¼ */
        #task-list-ul { list-style: none; padding: 0; }
        .task-card {
            background: white; border: 1px solid #eee; padding: 15px; margin-bottom: 15px;
            border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative;
        }
        .task-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .task-title { font-size: 18px; font-weight: bold; color: #2c3e50; }
        .task-meta { font-size: 12px; color: #7f8c8d; margin-bottom: 8px; }
        .task-desc { color: #555; white-space: pre-wrap; margin-bottom: 10px; }
        .add-btn {
            position: absolute;  /* çµ•å°å®šä½ï¼šè®“å®ƒè„«é›¢åŸæœ¬çš„å®¹å™¨ */
            top: 20px;           /* è·é›¢ä¸Šæ–¹ 20px */
            right: 30px;         /* è·é›¢å³æ–¹ 30px */
            
            /* ä»¥ä¸‹æ˜¯åŸæœ¬çš„å¤–è§€è¨­å®šï¼Œä¿ç•™å³å¯ */
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            z-index: 10; /* ç¢ºä¿å®ƒæµ®åœ¨æœ€ä¸Šå±¤ */
        }
        .delete-btn { background-color: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }

        /* --- å½ˆå‡ºè¦–çª— (Modal) CSS --- */
        .modal {
            display: none; /* é è¨­éš±è— */
            position: fixed; 
            z-index: 1000; 
            left: 0; top: 0; 
            width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.5); /* åŠé€æ˜é»‘åº• */
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .modal h3 { margin-top: 0; color: #2c3e50; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #34495e; }
        .form-group input, .form-group textarea {
            width: 100%; padding: 8px; box-sizing: border-box; 
            border: 1px solid #ccc; border-radius: 4px; font-size: 14px;
        }
        .modal-actions { text-align: right; margin-top: 20px; }
        .btn-cancel { background: #95a5a6; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        .btn-save { background: #2ecc71; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        /* å·²å®Œæˆä»»å‹™çš„æ¨£å¼ï¼šåˆªé™¤ç·š + è®Šæ·¡ */
        .task-completed .task-title {
            text-decoration: line-through;
            color: #95a5a6;
        }
        /* å®ŒæˆæŒ‰éˆ•çš„æ¨£å¼ */
        .btn-check {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }
        .btn-check:hover { background-color: #27ae60; }

        /* å¦‚æœä»»å‹™å·²å®Œæˆï¼ŒæŒ‰éˆ•æ”¹å€‹é¡è‰² (ä¾‹å¦‚ç°è‰²) */
        .task-completed .btn-check {
            background-color: #bdc3c7;
        }
        /* ç·¨è¼¯æŒ‰éˆ•æ¨£å¼ */
        .btn-edit-task {
            background-color: #f39c12; /* æ©˜è‰² */
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }
        .btn-edit-task:hover { background-color: #e67e22; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div id="user-info">
            <span id="username-display">è¼‰å…¥ä¸­...</span>
            <button class="btn-edit" onclick="changeName()">ä¿®æ”¹æš±ç¨±</button>
        </div>
        <button class="nav-btn active" onclick="switchTab('chat')">ğŸ’¬ èŠå¤©å®¤</button>
        <button class="nav-btn" onclick="switchTab('task')">ğŸ“‹ æˆ‘çš„ä»»å‹™</button>
    </div>

    <div id="main-content">
        <div id="section-chat" class="page-section active">
            <ul id="chat-list"></ul>
            <div id="input-area">
                <select id="recipient"><option value="all">æ‰€æœ‰äºº</option></select>
                <input id="msg-input" placeholder="è¼¸å…¥è¨Šæ¯...">
                <button onclick="send()" style="padding:10px; background:#1abc9c; color:white; border:none; border-radius:4px; cursor:pointer;">é€å‡º</button>
            </div>
        </div>

        <div id="section-task" class="page-section">
            <div id="task-container">
                <div style="text-align: right; margin-bottom: 10px;">
                    <button class="add-btn" onclick="openModal()">+ æ–°å¢ä»»å‹™</button>
                </div>
                <ul id="task-list-ul"></ul>
            </div>
        </div>
    </div>

    <div id="taskModal" class="modal">
        <div class="modal-content">
            <h3>æ–°å¢å¾…è¾¦äº‹é …</h3>
            
            <div class="form-group">
                <label>æ¨™é¡Œ</label>
                <input type="text" id="m-title" placeholder="ä¾‹å¦‚ï¼šå®Œæˆå ±å‘Š">
            </div>
            
            <div class="form-group">
                <label>ç´°ç¯€èªªæ˜</label>
                <textarea id="m-desc" rows="3" placeholder="è¼¸å…¥æ›´å¤šç´°ç¯€..."></textarea>
            </div>
            
            <div class="form-group">
                <label>æœ€å¾ŒæœŸé™</label>
                <input type="datetime-local" id="m-deadline">
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn-save" onclick="submitTask()">å„²å­˜</button>
            </div>
        </div>
    </div>

<script>
    const input = document.getElementById("msg-input");
    // --- å…±ç”¨èˆ‡åˆ‡æ› ---
    function switchTab(tab) {
        document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`section-${tab}`).classList.add('active');
        if(tab === 'chat') document.querySelectorAll('.nav-btn')[0].classList.add('active');
        else {
            document.querySelectorAll('.nav-btn')[1].classList.add('active');
            loadTasks();
        }
    }

    // --- èŠå¤©å®¤ ---
    let ws = null;
    fetch("/refresh", { method: "POST" }).then(res=>res.json()).then(data => {
        ws = new WebSocket(`ws://${window.location.host}/ws/chat?token=${data.access_token}`);
        ws.onmessage = (e) => {
            let li = document.createElement("li"); li.innerText = e.data;
            document.getElementById("chat-list").appendChild(li);
            document.getElementById("chat-list").scrollTop = document.getElementById("chat-list").scrollHeight;
        };
    });
    function send(){
        let input = document.getElementById("msg-input");
        if(ws && input.value.trim()) {
            ws.send(JSON.stringify({to: document.getElementById("recipient").value, message: input.value}));
            input.value = "";
        }
    }
    
    // åˆå§‹åŒ–è®€å–
    fetch("/user/username").then(r=>r.json()).then(d=>document.getElementById("username-display").innerText = d.name);
    function changeName(){ 
        let n=prompt("æ–°æš±ç¨±:"); 
        if(n) fetch("/user/username",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:n})}).then(()=>location.reload()); 
    }

    // ==========================================
    // --- ä»»å‹™ç³»çµ± (Modal ç‰ˆæœ¬) ---
    // ==========================================
    // å®šç¾© loadName å‡½å¼
    let allTasks = [];       // ç”¨ä¾†æš«å­˜æ‰€æœ‰ä»»å‹™è³‡æ–™
    let editingTaskId = null; // ç”¨ä¾†è¨˜éŒ„ç¾åœ¨æ­£åœ¨ç·¨è¼¯å“ªä¸€å€‹ä»»å‹™ (null ä»£è¡¨æ˜¯æ–°å¢æ¨¡å¼)
    function loadName(){
        fetch("/user/username")
        .then(res => res.json())
        .then(data => {
            // æ›´æ–°ç¶²é å·¦ä¸Šè§’çš„é¡¯ç¤º
            document.getElementById("username-display").innerText = data.name;
        })
        .catch(err => console.error("ç„¡æ³•è®€å–æš±ç¨±", err));
    }
    // 1. é–‹å•Ÿè¦–çª—
    function openModal(isEditMode = false) {
        const modal = document.getElementById('taskModal');
        const titleLabel = document.querySelector('#taskModal h3');

        modal.style.display = 'flex';

        if (!isEditMode) {
            // --- æ–°å¢æ¨¡å¼ ---
            editingTaskId = null; // æ¸…ç©ºç·¨è¼¯ ID
            titleLabel.innerText = "æ–°å¢å¾…è¾¦äº‹é …";
            // æ¸…ç©ºè¼¸å…¥æ¡†
            document.getElementById('m-title').value = "";
            document.getElementById('m-desc').value = "";
            document.getElementById('m-deadline').value = "";
        }
    }

    function editTask(id) {
        // å¾æš«å­˜çš„é™£åˆ—ä¸­æ‰¾åˆ°é€™ç­†ä»»å‹™
        const task = allTasks.find(t => t.id === id);
        if (!task) return;

        // è¨­å®šç‚ºç·¨è¼¯æ¨¡å¼
        editingTaskId = id;
        document.querySelector('#taskModal h3').innerText = "ç·¨è¼¯å¾…è¾¦äº‹é …";

        // æŠŠèˆŠè³‡æ–™å¡«é€²å»
        document.getElementById('m-title').value = task.title;
        document.getElementById('m-desc').value = task.description || "";
        document.getElementById('m-deadline').value = task.deadline || "";

        // é–‹å•Ÿè¦–çª— (å‚³å…¥ true ä»£è¡¨æ˜¯ç·¨è¼¯æ¨¡å¼)
        openModal(true);
    }
    // 2. é—œé–‰è¦–çª—
    function closeModal() {
        document.getElementById('taskModal').style.display = 'none';
        editingTaskId = null; // é—œé–‰æ™‚é‡ç½®ç‹€æ…‹
    }

    // 3. é€å‡ºè³‡æ–™ (å‘¼å«å¾Œç«¯)
    async function submitTask() {
        const title = document.getElementById('m-title').value.trim();
        const desc = document.getElementById('m-desc').value.trim();
        const deadline = document.getElementById('m-deadline').value;

        if(!title) return alert("è«‹è‡³å°‘è¼¸å…¥æ¨™é¡Œ");

        const taskData = {
            title: title,
            description: desc,
            deadline: deadline,
            is_completed: false 
        };

        try {
            let url = '/tasks/';
            let method = 'POST';

            // å¦‚æœ editingTaskId æœ‰å€¼ï¼Œä»£è¡¨ç¾åœ¨æ˜¯ã€Œç·¨è¼¯æ¨¡å¼ã€
            if (editingTaskId) {
                url = `/tasks/${editingTaskId}`; // æ”¹æˆå‘¼å« PUT /tasks/{id}
                method = 'PUT';
            }

            const res = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(taskData)
            });

            if(res.ok) {
                closeModal();
                loadTasks(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
            } else {
                alert("æ“ä½œå¤±æ•—");
            }
        } catch (error) {
            console.error("Error:", error);
            alert("é€£ç·šéŒ¯èª¤");
        }
    }

    // 4. è¼‰å…¥ä»»å‹™åˆ—è¡¨ (é¡¯ç¤ºæ¨™é¡Œã€æ™‚é–“ã€ç´°ç¯€)
    async function loadTasks() {
        try {
            const res = await fetch('/tasks/');
            if (!res.ok) return;

            // å­˜åˆ°å…¨åŸŸè®Šæ•¸ï¼Œè®“ editTask å¯ä»¥æŸ¥
            allTasks = await res.json(); 
            
            const list = document.getElementById('task-list-ul');
            list.innerHTML = '';

            allTasks.forEach(task => {
                const li = document.createElement('li');
                li.className = 'task-card';
                if (task.is_completed) li.classList.add('task-completed');

                let timeHtml = '';
                if(task.deadline) {
                    const dateObj = new Date(task.deadline);
                    timeHtml = `<span style="color:#e67e22; font-weight:bold;">ğŸ•’ åˆ°æœŸæ—¥ï¼š${dateObj.toLocaleString()}</span>`;
                }

                const btnText = task.is_completed ? "â†©ï¸ å¾©åŸ" : "âœ… å®Œæˆ";

                li.innerHTML = `
                    <div class="task-header">
                        <span class="task-title">${task.title}</span>
                        <div>
                            <button class="btn-edit-task" onclick="editTask(${task.id})">âœï¸ ç·¨è¼¯</button>
                            
                            <button class="btn-check" onclick="toggleTask(${task.id})">${btnText}</button>
                            <button class="delete-btn" onclick="deleteTask(${task.id})">åˆªé™¤</button>
                        </div>
                    </div>
                    <div class="task-meta">${timeHtml}</div>
                    <div class="task-desc">${task.description || '(ç„¡è©³ç´°èªªæ˜)'}</div>
                `;
                list.appendChild(li);
            });
        } catch (error) {
            console.error("loadTasks error:", error);
        }
    }

    async function toggleTask(taskId) {
        try {
            // å‘¼å«å¾Œç«¯ PUT API
            const res = await fetch(`/tasks/${taskId}/toggle`, { method: 'PUT' });
            if (res.ok) {
                // æˆåŠŸå¾Œé‡æ–°è¼‰å…¥ï¼Œå› ç‚ºå¾Œç«¯æœ‰è¨­å®šæ’åºï¼Œ
                // æ‰€ä»¥å·²å®Œæˆçš„ä»»å‹™æœƒè‡ªå‹•è·‘åˆ°æœ€ä¸‹é¢
                loadTasks(); 
            } else {
                alert("æ›´æ–°å¤±æ•—");
            }
        } catch (e) {
            console.error(e);
            alert("é€£ç·šéŒ¯èª¤");
        }
    }
    
    async function deleteTask(id) {
        if(confirm("ç¢ºå®šåˆªé™¤?")) {
            await fetch(`/tasks/${id}`, {method:'DELETE'});
            loadTasks();
        }
    }
    input.addEventListener("keydown", function(e){
        if(e.key === "Enter" && !e.shiftKey){
            e.preventDefault();
            send();
        }
    });
    // ==========================================
    // --- è£œå›ï¼šè®€å–æ­·å²èŠå¤©ç´€éŒ„ ---
    // ==========================================
    
    async function loadChatHistory() {
        try {
            // å‘¼å«å¾Œç«¯ API æ‹¿å–æœ€è¿‘ 50 ç­†è³‡æ–™
            const res = await fetch("/messages");
            const messages = await res.json();
            
            const list = document.getElementById("chat-list");
            list.innerHTML = ""; // å…ˆæ¸…ç©ºï¼Œé¿å…é‡è¤‡é¡¯ç¤º

            messages.forEach(msg => {
                const li = document.createElement("li");
                // æ ¼å¼ï¼š åå­—: å…§å®¹
                li.innerText = `${msg.name}: ${msg.content}`;
                list.appendChild(li);
            });

            // è®€å–å®Œå¾Œï¼Œè‡ªå‹•æ²å‹•åˆ°æœ€åº•éƒ¨ï¼ˆçœ‹æœ€æ–°è¨Šæ¯ï¼‰
            list.scrollTop = list.scrollHeight;
            
        } catch (error) {
            console.error("è®€å–æ­·å²è¨Šæ¯å¤±æ•—:", error);
        }
    }

    loadName();        // è¼‰å…¥ä½¿ç”¨è€…æš±ç¨±
    loadChatHistory();

    loadTasks();       // è¼‰å…¥ä»»å‹™æ¸…å–®
</script>
</body>
</html>